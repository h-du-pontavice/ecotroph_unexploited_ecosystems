# ---------------------------------------------------------------------
# ECoTroph Core function 
# ---------------------------------------------------------------------
rm(list=ls())
# ---------------------------------------------------------------------
# Tl= Trophic Level
# TE: Transfer efficiency
# TE LTL: low trophic levels transfer efficiency (TE of the planktonic food web derived from COBALT https://doi.org/10.1016/j.pocean.2013.07.001)
# TE HTL: higher trophic levels transfer efficiency (du pontavice et al., 2019 DOI: https://doi.org/10.1111/gcb.14944)
# NPP: Net Primary Production
# SST: Sea Surface Temperature
# ---------------------------------------------------------------------
# load required library
# install.packages("tidyverse")
library("tidyverse")
# ---------------------------------------------------------------------
# load several fonction 
source("FUNCTIONS/flow_kinetic.R") # calculate the flow kinetic
source("FUNCTIONS/transfer_efficiency_htl.R") # calulculate TE HTL
source("FUNCTIONS/transfer_efficiency_tl_2to3.R") # transition between TE LTL and TE LTL
source("FUNCTIONS/production_tl_2to3.R") #process to calculate consumer production between TL=2 and TL=3
source("FUNCTIONS/geom_sequence_prod.R") # geometric sequence to speed up the process to calculate consumer production
# ---------------------------------------------------------------------
# 4 examples: 4 grid cells chosen randomly for polar, temperate, tropical and upwelling, respectively, between 1950 and 2100 (see at the end of the script)
# Each example is based on the earth sytem model : GFDL-ESM2M (Dunne et al., 2012; DOI: https://doi.org/10.1175/JCLI-D-11-00560.1) and the emission scenario : RCP8.5 ("no mitigation policy" scenario)
load("DATA/example_data.RData")
#
# data_envi<-data_envi_tropical
# surface_area<-surface_area_tropical
# eco_type<-"tropical"
# ---------------------------------------------------------------------
# data_envi : data frame with 4 columns:
# 1.year (one single year or mutiple years, in the example from 1950 to 2100)
# 2.sst (in °C)
# 3.npp (in mole of Carbon .m-2.s-1)
# 4.te_ltl (dimensionless between 0 and 1)
# eco_type : 4 choices of ecosystem types: "polar","temperate","tropical","upwelling" # the sensivty of te_htl to temperature is varying among ecosystem types (du pontavice et al., 2019 DOI: https://doi.org/10.1111/gcb.14944)
# surface_area: Surface of the ecosystem in m²
ecotroph_core<-function(data_envi,eco_type,surface_area) { 
  min_year<-as.character(min(data_envi$year))
  max_year<-as.character(max(data_envi$year))
  # NPP: Net primary production in t.an-1 (data in mole.m-2.s-1 --> x 12 g.mol-1 (mole of carbon to g of carbon) 
  #  x 365*24*3600 (day*hour*sec) (second ==> year)
  # x * 9 (carbon ==> biomass)
  data_envi$npp <- data_envi$npp * 365 * 24 * 3600 * 9 * 12 * surface_area #* 10^(-6)
  # make sure that year are well ordered
  data_envi<-data_envi[order(data_envi$year),]
  # ---------------------------------------------------------------------
  # 1st step: Calculate production from TL=2 to TL=7
  # ---------------------------------------------------------------------
  # Production at TL = 2: because by convention prod2/NPP = TE LTL
  data_envi$prod2<- data_envi$npp * data_envi$te_ltl
  # mean biomass flow between 2 and 2.1
  data_envi$flow_m2<-data_envi$prod2/0.1
  # biomass flow at TL=0.1
  data_envi$flow2<-data_envi$flow_m2*(0.1*(-log(data_envi$te_ltl)))/(1-data_envi$te_ltl^0.1)
  # biomass flow between TL=2 and TL=3 and mean biomass flow between TL=2 and TL=3
  # with the transition :
  # from TE LTL at TL=2
  # to TE HTL at TL=3 (TE LTL in du Pontavice et al., 2019)
  seq_tl_2to3<-seq(2.1,3,.1)
  if (nrow(data_envi)>1) { # if mutiple year
    # prod_tl_2to3: sst, flow2, flow_m2, te_ltl, ecotype,seq_tl
    prod_2to3<-apply(data_envi,1,function(x) prod_tl_2to3(x[2],x[7],x[6],x[4],eco_type,seq_tl_2to3))
  } else { # if one single year
    prod_2to3<-with(data_envi, prod_tl_2to3(sst,flow2,flow_m2,eco_type,seq_tl_2to3)) %>%
      as.data.frame()
  }
  rownames(prod_2to3)<-seq(2,3,.1)
  # Production between TL=3 and TL=7
  # we select production at TL=3
  data_envi$prod3<-prod_2to3[11,]
  # we recalculate:
  # mean biomass flow at TL=3
  data_envi$flow_m3<-data_envi$prod3/0.1
  # biomass flow at TL=3
  data_envi$flow3<-data_envi$flow_m3*(0.1*(-log(te_htl_funct(eco_type,data_envi$sst))))/(1-(te_htl_funct(eco_type,data_envi$sst))^0.1)
  seq_tl_3to7<-seq(3,7,.1)
  # calculate flow between 3 and 7
  prod_3to7<-apply(data_envi,1,function(x) 
    geomseq_n_prod(
      flow3=x[10],
      te_htl=(te_htl_funct(eco_type,x[2])),
      len_seq=length(seq_tl_3to7)
    )
  ) 
  rownames(prod_3to7)<-seq(3,7,.1)
  # prod_2to3[1:11,1:5]
  # prod_3to7[1:41,1:5]
  # Gathering prod between TL = 2 and TL = 2.9 and between TL = 3 and TL = 7
  if (nrow(data_envi)>1) { # if mutiple year
    prod<-rbind(prod_2to3[(1:10),],prod_3to7)
  } else {  # if one single year
    prod<-c(prod_2to3[(1:10),],prod_3to7) %>%
      as.data.frame()
  }
  seq_tl<-seq(2,7,.1)
  rownames(prod)<-seq_tl
  colnames(prod)<-data_envi$year
  # ---------------------------------------------------------------------
  # 2nd step: Calculate biomass from TL=2 to TL=7
  # ---------------------------------------------------------------------
  # Biomass : Production(tl)/Kinetic(tl)
  biom<-prod/(apply(data_envi, 1, function(x)
    apply(as.data.frame(seq_tl),1,function(y) kinetic_funct(y[1],x[2]))))
  # ---------------------------------------------------------------------
  biom<-as.data.frame(biom) %>%
    bind_cols(tl=(rownames(biom))) %>%
    pivot_longer(cols= (min_year:max_year),names_to = "year", values_to = "biomass") %>%
    as.data.frame()
  prod<-as.data.frame(prod) %>%
    bind_cols(tl=(rownames(prod))) %>%
    pivot_longer(cols= (min_year:max_year),names_to = "year", values_to = "production") %>%
    as.data.frame()
  result<-inner_join(prod,biom, by=c('tl','year'))
  return(result)
}
# ---------------------------------------------------------------------
# 4 EXAMPLES FOR POLAR, TEMPERATE, TROPICAL AND UPWELLING (random choice) between 1950 and 2100
# 4 example with 4 1°x1° grid cells (random choice)
# POLAR
# Bering Sea (coordinates: 173.5°W, 55.5°N)
output_ecotroph<-ecotroph_core(data_envi_polar,"polar",surface_area_polar)
# TEMPERATE
# West of Ireland (coordinates: 12.5°W, 52.5°N)
output_ecotroph<-ecotroph_core(data_envi_temperate,"temperate",surface_area_temperate)
# TROPICAL
# Southwest of Galápagos (coordinates: 94.5°W, 3.5°S)
output_ecotroph<-ecotroph_core(data_envi_tropical,"tropical",surface_area_tropical)
# UPWELLING
# Benguela upwelling system (coordinates: 11.5°E, 28.5°S)
output_ecotroph<-ecotroph_core(data_envi_upwelling,"upwelling",surface_area_upwelling)
# ---------------------------------------------------------------------
head(output_ecotroph)
dim(output_ecotroph)


